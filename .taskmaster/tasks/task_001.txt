# Task ID: 1
# Title: Database Schema Setup
# Status: pending
# Dependencies: None
# Priority: high
# Description: Create basic database schema files and configuration for the Rust API project.
# Details:
This task involves setting up the database schema and configuration files for the project:
1. Create `src/schema.rs` with basic table definitions
2. Set up migration files in the `migrations/` directory
3. Update `Cargo.toml` to include necessary database dependencies such as diesel, sqlx, or similar ORM

Example for `Cargo.toml` additions:
```toml
[dependencies]
diesel = { version = "2.1.0", features = ["postgres", "r2d2"] }
r2d2 = "0.8.10"
dotenv = "0.15.0"
```

Example for `src/schema.rs`:
```rust
// Basic schema definitions
table! {
    users (id) {
        id -> Integer,
        username -> Varchar,
        email -> Varchar,
        password_hash -> Varchar,
        created_at -> Timestamp,
    }
}

table! {
    products (id) {
        id -> Integer,
        name -> Varchar,
        description -> Text,
        price -> Numeric,
        inventory_count -> Integer,
    }
}

table! {
    carts (id) {
        id -> Integer,
        user_id -> Integer,
        created_at -> Timestamp,
    }
}

table! {
    cart_items (id) {
        id -> Integer,
        cart_id -> Integer,
        product_id -> Integer,
        quantity -> Integer,
    }
}
```

Create basic migration files in `migrations/` directory for initial schema setup.

# Test Strategy:
1. Verify that all required files are created: `src/schema.rs`, migration files, and database dependencies in `Cargo.toml`
2. Run a simple validation to ensure the schema definitions are syntactically correct
3. Check that the migration files can be applied to create the database schema
4. Validate that the database dependencies in `Cargo.toml` are correctly specified and can be resolved

# Subtasks:
## 1. Add Database Dependencies to Cargo.toml [pending]
### Dependencies: None
### Description: Update the Cargo.toml file to include all necessary database-related dependencies for the project.
### Details:
Add the following dependencies to Cargo.toml:

```toml
[dependencies]
diesel = { version = "2.1.0", features = ["postgres", "r2d2", "chrono"] }
r2d2 = "0.8.10"
dotenv = "0.15.0"
chrono = { version = "0.4", features = ["serde"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
```

After adding these dependencies, run `cargo build` to download and compile them.

## 2. Create Database Configuration Module [pending]
### Dependencies: None
### Description: Create a database configuration module to handle connection setup and environment variables.
### Details:
1. Create a new file at `src/config/db.rs`
2. Implement database connection configuration:

```rust
use diesel::pg::PgConnection;
use diesel::r2d2::{self, ConnectionManager};
use dotenv::dotenv;
use std::env;

pub type Pool = r2d2::Pool<ConnectionManager<PgConnection>>;
pub type DbConnection = r2d2::PooledConnection<ConnectionManager<PgConnection>>;

pub fn establish_connection_pool() -> Pool {
    dotenv().ok();
    
    let database_url = env::var("DATABASE_URL")
        .expect("DATABASE_URL must be set");
    
    let manager = ConnectionManager::<PgConnection>::new(database_url);
    r2d2::Pool::builder()
        .build(manager)
        .expect("Failed to create pool")
}
```

3. Create a `.env` file in the project root with: `DATABASE_URL=postgres://username:password@localhost/database_name`

## 3. Define Database Schema in schema.rs [pending]
### Dependencies: None
### Description: Create the schema.rs file with table definitions for users, products, carts, and cart_items.
### Details:
Create `src/schema.rs` with the following content:

```rust
table! {
    users (id) {
        id -> Integer,
        username -> Varchar,
        email -> Varchar,
        password_hash -> Varchar,
        created_at -> Timestamp,
    }
}

table! {
    products (id) {
        id -> Integer,
        name -> Varchar,
        description -> Text,
        price -> Numeric,
        inventory_count -> Integer,
    }
}

table! {
    carts (id) {
        id -> Integer,
        user_id -> Integer,
        created_at -> Timestamp,
    }
}

table! {
    cart_items (id) {
        id -> Integer,
        cart_id -> Integer,
        product_id -> Integer,
        quantity -> Integer,
    }
}

joinable!(cart_items -> carts (cart_id));
joinable!(cart_items -> products (product_id));
joinable!(carts -> users (user_id));

allow_tables_to_appear_in_same_query!(
    users,
    products,
    carts,
    cart_items,
);
```

This defines the database schema and relationships between tables.

## 4. Create Database Migration Files [pending]
### Dependencies: None
### Description: Set up migration files for creating the database tables defined in the schema.
### Details:
1. Install the diesel CLI if not already installed: `cargo install diesel_cli --no-default-features --features postgres`
2. Run `diesel setup` to initialize the migrations directory
3. Create migration files for each table:

```bash
diesel migration generate create_users
diesel migration generate create_products
diesel migration generate create_carts
diesel migration generate create_cart_items
```

4. For each migration, implement the up.sql and down.sql files. Example for create_users:

up.sql:
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR NOT NULL UNIQUE,
  email VARCHAR NOT NULL UNIQUE,
  password_hash VARCHAR NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

down.sql:
```sql
DROP TABLE users;
```

Implement similar migration files for products, carts, and cart_items tables with appropriate foreign key constraints.

## 5. Create Model Structs for Database Entities [pending]
### Dependencies: None
### Description: Implement Rust model structs that correspond to the database tables, with appropriate traits for serialization and database operations.
### Details:
Create a new file at `src/models.rs` with the following content:

```rust
use crate::schema::*;
use chrono::NaiveDateTime;
use diesel::prelude::*;
use serde::{Deserialize, Serialize};

#[derive(Queryable, Identifiable, Serialize, Deserialize)]
#[table_name = "users"]
pub struct User {
    pub id: i32,
    pub username: String,
    pub email: String,
    pub password_hash: String,
    pub created_at: NaiveDateTime,
}

#[derive(Insertable, Deserialize)]
#[table_name = "users"]
pub struct NewUser {
    pub username: String,
    pub email: String,
    pub password_hash: String,
}

#[derive(Queryable, Identifiable, Serialize, Deserialize)]
#[table_name = "products"]
pub struct Product {
    pub id: i32,
    pub name: String,
    pub description: String,
    pub price: f64,
    pub inventory_count: i32,
}

#[derive(Insertable, Deserialize)]
#[table_name = "products"]
pub struct NewProduct {
    pub name: String,
    pub description: String,
    pub price: f64,
    pub inventory_count: i32,
}

#[derive(Queryable, Identifiable, Associations, Serialize, Deserialize)]
#[belongs_to(User)]
#[table_name = "carts"]
pub struct Cart {
    pub id: i32,
    pub user_id: i32,
    pub created_at: NaiveDateTime,
}

#[derive(Insertable)]
#[table_name = "carts"]
pub struct NewCart {
    pub user_id: i32,
}

#[derive(Queryable, Identifiable, Associations, Serialize, Deserialize)]
#[belongs_to(Cart)]
#[belongs_to(Product)]
#[table_name = "cart_items"]
pub struct CartItem {
    pub id: i32,
    pub cart_id: i32,
    pub product_id: i32,
    pub quantity: i32,
}

#[derive(Insertable)]
#[table_name = "cart_items"]
pub struct NewCartItem {
    pub cart_id: i32,
    pub product_id: i32,
    pub quantity: i32,
}
```

Update `src/lib.rs` or `src/main.rs` to include these modules:

```rust
pub mod config;
pub mod models;
pub mod schema;
```

