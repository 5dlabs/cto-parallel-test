```mermaid
sequenceDiagram
    participant Client
    participant CartAPI as Cart API<br/>/api/cart
    participant Auth as JWT Validator<br/>(Task 3)
    participant CartSvc as CartService
    participant ProdSvc as ProductService<br/>(Task 4)

    Note over Client,ProdSvc: Add Item to Cart Flow

    Client->>CartAPI: POST /api/cart/add<br/>Authorization: Bearer {token}<br/>{product_id, quantity}

    CartAPI->>Auth: validate_token(token)
    alt Token Invalid
        Auth-->>CartAPI: Error
        CartAPI-->>Client: 401 Unauthorized
    else Token Valid
        Auth-->>CartAPI: Claims {sub: user_id}

        CartAPI->>ProdSvc: get_by_id(product_id)
        alt Product Not Found
            ProdSvc-->>CartAPI: None
            CartAPI-->>Client: 404 Product not found
        else Product Found
            ProdSvc-->>CartAPI: Product {id, name, price, inventory}

            alt Inventory < Quantity
                CartAPI-->>Client: 400 Not enough inventory
            else Inventory OK
                CartAPI->>CartSvc: add_item(user_id, product, quantity)
                CartSvc->>CartSvc: Get/create user cart
                CartSvc->>CartSvc: Add/update CartItem
                CartSvc-->>CartAPI: Updated Cart
                CartAPI-->>Client: 200 OK Cart JSON
            end
        end
    end
```

```mermaid
graph TB
    subgraph "Module Integration"
        Task2[Task 2: API Routes<br/>Routing Infrastructure]
        Task3[Task 3: Auth<br/>JWT Validation]
        Task4[Task 4: Catalog<br/>Product Lookup]
        Task5[Task 5: Cart<br/>THIS TASK]
    end

    Task2 -.provides routing.-> Task5
    Task3 -.provides JWT.-> Task5
    Task4 -.provides products.-> Task5

    Task5 --> CartSvc[CartService<br/>Cart Management]
    Task5 --> CartAPI[Cart API Routes<br/>HTTP Endpoints]

    CartAPI --> Auth[validate_token<br/>from Task 3]
    CartAPI --> ProdSvc[ProductService<br/>from Task 4]
    CartAPI --> CartSvc

    style Task5 fill:#FFD700,stroke:#FF8C00,stroke-width:4px
    style Task2 fill:#90EE90,stroke:#006400,stroke-width:2px
    style Task3 fill:#87CEEB,stroke:#4682B4,stroke-width:2px
    style Task4 fill:#FFB6C1,stroke:#FF1493,stroke-width:2px
```

```mermaid
classDiagram
    class CartItem {
        +i32 product_id
        +i32 quantity
        +String product_name
        +Decimal unit_price
    }

    class Cart {
        +i32 id
        +i32 user_id
        +Vec~CartItem~ items
    }

    class CartService {
        -Arc~Mutex~HashMap~i32,Cart~~~ carts
        -Arc~Mutex~i32~~ next_id
        +new() Self
        +get_or_create_cart(i32) Cart
        +add_item(i32, Product, i32) Cart
        +remove_item(i32, i32) Option~Cart~
        +get_cart(i32) Option~Cart~
        +clear_cart(i32) Option~Cart~
    }

    class CartRoutes {
        <<API Handlers>>
        +get_cart(req, service) Response
        +add_item(req, service, product_service, body) Response
        +remove_item(req, service, path) Response
        +clear_cart(req, service) Response
        +configure_cart_routes(cfg) void
    }

    Cart *-- CartItem : contains
    CartService --> Cart : manages
    CartRoutes --> CartService : uses
    CartRoutes --> validate_token : authenticates
    CartRoutes --> ProductService : validates

    note for CartItem "Denormalized product data\nStored at add time"
    note for CartService "HashMap by cart_id\nSearch by user_id"
    note for CartRoutes "All endpoints require JWT\n401 if auth fails"
```

```mermaid
graph LR
    subgraph "Cart API Endpoints"
        GET[GET /api/cart<br/>Get user's cart]
        POST1[POST /api/cart/add<br/>Add item]
        DELETE[DELETE /api/cart/remove/:id<br/>Remove item]
        POST2[POST /api/cart/clear<br/>Clear cart]
    end

    subgraph "Authentication Layer"
        JWT[JWT Validation<br/>All endpoints]
    end

    subgraph "Business Logic"
        CartSvc2[CartService<br/>Cart operations]
        ProdSvc2[ProductService<br/>Product validation]
    end

    GET --> JWT
    POST1 --> JWT
    DELETE --> JWT
    POST2 --> JWT

    JWT --> CartSvc2
    POST1 --> ProdSvc2
    ProdSvc2 --> CartSvc2

    style JWT fill:#FF6B6B,stroke:#C92A2A,stroke-width:3px
    style CartSvc2 fill:#90EE90,stroke:#006400,stroke-width:2px
    style ProdSvc2 fill:#FFB6C1,stroke:#FF1493,stroke-width:2px
```

```mermaid
stateDiagram-v2
    [*] --> Request: Client sends request
    Request --> ExtractToken: Parse Authorization header

    ExtractToken --> ValidateToken: Extract Bearer token
    ExtractToken --> Unauthorized: Missing/invalid format

    ValidateToken --> ExtractUserID: Token valid
    ValidateToken --> Unauthorized: Token invalid

    ExtractUserID --> CartOperation: Parse user_id from claims

    state CartOperation {
        [*] --> RouteCheck
        RouteCheck --> GetCart: GET /cart
        RouteCheck --> AddItem: POST /add
        RouteCheck --> RemoveItem: DELETE /remove/:id
        RouteCheck --> ClearCart: POST /clear

        AddItem --> ValidateProduct: Lookup product
        ValidateProduct --> CheckInventory: Product exists
        ValidateProduct --> NotFound: Product missing
        CheckInventory --> UpdateCart: Inventory OK
        CheckInventory --> BadRequest: Insufficient inventory

        GetCart --> UpdateCart
        RemoveItem --> UpdateCart
        ClearCart --> UpdateCart

        UpdateCart --> [*]
        NotFound --> [*]
        BadRequest --> [*]
    }

    CartOperation --> Success: 200 OK with Cart JSON
    CartOperation --> BadRequest: 400 Bad Request
    CartOperation --> NotFound: 404 Not Found

    Unauthorized --> [*]: 401 Unauthorized
    Success --> [*]
    BadRequest --> [*]
    NotFound --> [*]
```
