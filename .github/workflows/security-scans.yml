name: Security Scans

on:
  push:
    branches: [ main, feature/task-4-implementation ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  gitleaks:
    name: Secret Scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Run gitleaks
        continue-on-error: true  # Organization requires license
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITLEAKS_FORMAT: sarif
          GITLEAKS_REPORT_PATH: gitleaks.sarif
          # Use repo config to avoid false positives from explicit placeholders
          GITLEAKS_CONFIG: .gitleaks.toml
          # Fail the job on any findings (enforces zero-tolerance in CI)
          GITLEAKS_EXIT_CODE: "1"

      - name: Upload SARIF (gitleaks)
        if: always() && hashFiles('gitleaks.sarif') != ''
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@f94c9befffa4412c356fb5463a959ab7821dd57e # v3.31.3
        with:
          sarif_file: gitleaks.sarif

      - name: Enforce no secret leaks
        if: always() && hashFiles('gitleaks.sarif') != ''
        run: |
          # Fail the job if any findings exist in the SARIF
          count=$(jq -r '[.runs[]?.results[]?] | length' gitleaks.sarif)
          echo "gitleaks findings: ${count}"
          if [ "${count}" -gt 0 ]; then
            echo "Secret leaks detected by gitleaks (${count}). Failing job." >&2
            exit 1
          fi

  osv-scanner:
    name: Dependency Scan (OSV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Run OSV-Scanner (repo)
        uses: google/osv-scanner-action@9bb69575e74019c2ad085a1860787043adf47ccb # v1.8.0
        with:
          scan-args: >-
            --lockfile=Cargo.lock
            --format sarif
            --output osv-results.sarif

      - name: Set OSV_FAIL if vulnerabilities found
        run: |
          if [ -f osv-results.sarif ] && jq -e '.runs[]?.results? | length > 0' osv-results.sarif >/dev/null 2>&1; then
            echo "OSV vulnerabilities detected" >&2
            echo "OSV_FAIL=1" >> "$GITHUB_ENV"
          else
            echo "OSV_FAIL=0" >> "$GITHUB_ENV"
          fi

      - name: Upload SARIF (OSV)
        if: always() && hashFiles('osv-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@f94c9befffa4412c356fb5463a959ab7821dd57e # v3.31.3
        with:
          sarif_file: osv-results.sarif

      - name: Enforce no vulns
        if: env.OSV_FAIL == '1'
        run: |
          echo "Failing due to OSV vulnerabilities" >&2
          exit 1

  cargo-audit:
    name: RustSec Audit (cargo-audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Audit dependencies
        run: cargo audit -D warnings
