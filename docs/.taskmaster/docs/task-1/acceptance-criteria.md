# Acceptance Criteria: Database Schema Setup

## Required Files Created

### 1. Cargo.toml Dependencies
- [ ] `diesel = { version = "2.1.0", features = ["postgres", "r2d2", "chrono"] }` added
- [ ] `r2d2 = "0.8.10"` added
- [ ] `dotenv = "0.15.0"` added
- [ ] `chrono` with serde feature added
- [ ] `serde` and `serde_json` added

### 2. Schema Definition
- [ ] `src/schema.rs` exists and is auto-generated by Diesel
- [ ] Contains `users` table definition with 5 columns (id, username, email, password_hash, created_at)
- [ ] Contains `products` table definition with 5 columns (id, name, description, price, inventory_count)
- [ ] Contains `carts` table definition with 3 columns (id, user_id, created_at)
- [ ] Contains `cart_items` table definition with 4 columns (id, cart_id, product_id, quantity)
- [ ] Includes `joinable!` macros for all foreign key relationships
- [ ] Includes `allow_tables_to_appear_in_same_query!` macro

### 3. Database Configuration
- [ ] `src/config/db.rs` exists
- [ ] Defines `Pool` type alias for connection pool
- [ ] Defines `DbConnection` type alias
- [ ] Implements `establish_connection_pool()` function
- [ ] Uses `dotenv()` to load environment variables
- [ ] Reads `DATABASE_URL` from environment
- [ ] `src/config/mod.rs` exports the `db` module

### 4. ORM Models
- [ ] `src/models.rs` exists
- [ ] Defines `User` struct with `Queryable`, `Identifiable`, `Serialize`, `Deserialize` traits
- [ ] Defines `NewUser` struct with `Insertable` trait
- [ ] Defines `Product` struct with appropriate traits
- [ ] Defines `NewProduct` struct with `Insertable` trait
- [ ] Defines `Cart` struct with `Associations` trait (belongs_to User)
- [ ] Defines `NewCart` struct with `Insertable` trait
- [ ] Defines `CartItem` struct with `Associations` trait (belongs_to Cart and Product)
- [ ] Defines `NewCartItem` struct with `Insertable` trait

### 5. Migration Files
- [ ] `migrations/` directory exists
- [ ] `create_users` migration directory exists
- [ ] `create_users/up.sql` creates users table with UNIQUE constraints on username and email
- [ ] `create_users/down.sql` drops users table
- [ ] `create_products` migration directory exists
- [ ] `create_products/up.sql` creates products table
- [ ] `create_products/down.sql` drops products table
- [ ] `create_carts` migration directory exists
- [ ] `create_carts/up.sql` creates carts table with FOREIGN KEY to users
- [ ] `create_carts/down.sql` drops carts table
- [ ] `create_cart_items` migration directory exists
- [ ] `create_cart_items/up.sql` creates cart_items table with FOREIGN KEYs to carts and products
- [ ] `create_cart_items/down.sql` drops cart_items table

### 6. Environment Configuration
- [ ] `.env` file exists in project root
- [ ] Contains `DATABASE_URL` variable with PostgreSQL connection string

### 7. Module Registration
- [ ] `src/main.rs` or `src/lib.rs` declares `pub mod config;`
- [ ] Declares `pub mod models;`
- [ ] Declares `pub mod schema;`

## Functional Requirements

### Compilation and Build
- [ ] `cargo check` completes without errors
- [ ] `cargo build` completes successfully
- [ ] No dependency resolution errors
- [ ] No missing crate errors

### Database Operations
- [ ] `diesel setup` initializes the database successfully
- [ ] `diesel migration run` applies all migrations without errors
- [ ] All 4 tables are created in PostgreSQL
- [ ] `diesel migration revert` successfully rolls back migrations
- [ ] `diesel migration redo` tests both up and down migrations

### Schema Validation
- [ ] Users table has PRIMARY KEY on id
- [ ] Users table has UNIQUE constraints on username and email
- [ ] Products table has PRIMARY KEY on id
- [ ] Carts table has FOREIGN KEY constraint to users(id)
- [ ] Cart_items table has FOREIGN KEY constraint to carts(id)
- [ ] Cart_items table has FOREIGN KEY constraint to products(id)
- [ ] Foreign keys include `ON DELETE CASCADE`

### Data Types
- [ ] Integer columns use `INTEGER` or `SERIAL`
- [ ] String columns use `VARCHAR` or `TEXT`
- [ ] Price column uses `NUMERIC` for decimal precision
- [ ] Timestamp columns use `TIMESTAMP`
- [ ] Timestamp columns have `DEFAULT CURRENT_TIMESTAMP` where appropriate

### Connection Pooling
- [ ] Connection pool can be successfully created
- [ ] Pool uses r2d2 for connection management
- [ ] `DATABASE_URL` is required and validated
- [ ] Connection pool configuration is reasonable (default settings acceptable)

## Testing Requirements

### Manual Validation
- [ ] Run `cargo check` - should pass
- [ ] Run `cargo build` - should complete
- [ ] Run `diesel migration run` - should succeed
- [ ] Run `psql` to verify tables exist
- [ ] Run `diesel migration redo` - should work for all migrations

### Database Verification
Query PostgreSQL to verify schema:
```sql
-- Verify users table
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'users';

-- Verify foreign keys
SELECT constraint_name, table_name, column_name
FROM information_schema.key_column_usage
WHERE table_name IN ('carts', 'cart_items');
```

### Code Verification
```bash
# Verify schema.rs was generated
ls -l src/schema.rs

# Verify migrations exist
ls -R migrations/

# Check models compile
cargo check --lib
```

## Quality Standards

### Code Quality
- [ ] Code follows Rust naming conventions
- [ ] All structs have appropriate derives
- [ ] No compiler warnings
- [ ] Proper use of Diesel macros and attributes
- [ ] Comments explain non-obvious configuration

### Documentation
- [ ] Models have clear struct names
- [ ] Migration files are properly numbered and named
- [ ] `.env.example` or README documents required environment variables

### Error Handling
- [ ] Connection pool creation includes `.expect()` with clear error message
- [ ] Environment variable loading handles missing values gracefully
- [ ] Migration errors are descriptive

## Non-Functional Requirements

### Performance
- [ ] Connection pool is configured for reasonable concurrency
- [ ] Schema uses appropriate indexes (PRIMARY KEY, UNIQUE)
- [ ] Foreign key constraints maintain referential integrity

### Security
- [ ] Password hash field is included (not plaintext password)
- [ ] `.env` file is in `.gitignore` (credentials not committed)
- [ ] SQL injection is prevented by using Diesel ORM

### Maintainability
- [ ] Migration files are version-controlled
- [ ] Schema changes are reversible (down migrations)
- [ ] Module structure follows Rust best practices
- [ ] Clear separation of concerns (config, models, schema)

## Edge Cases and Error Conditions

### Database Connection Failures
- [ ] System handles missing DATABASE_URL gracefully
- [ ] System handles invalid connection strings
- [ ] System handles PostgreSQL not running

### Migration Issues
- [ ] Handles re-running migrations (idempotent)
- [ ] Rollback works correctly for all migrations
- [ ] Foreign key dependencies are respected in migration order

## Success Validation Commands

Run these commands to validate acceptance criteria:

```bash
# 1. Check dependencies
cargo check

# 2. Verify migrations
diesel migration run
diesel migration redo

# 3. Verify schema
cat src/schema.rs | grep "table!"

# 4. Verify models
cat src/models.rs | grep "struct"

# 5. Verify connection
# (This would be a simple connection test in code)

# 6. Check database
psql $DATABASE_URL -c "\dt"
```

## Definition of Done

The task is complete when:
1. All files listed above are created
2. All functional requirements pass
3. All testing requirements pass
4. `cargo check` and `cargo build` succeed
5. `diesel migration run` creates all tables successfully
6. Database schema matches the architecture specification
7. Code is ready for integration with Task 2 (API Endpoints)

## Sign-Off Checklist

- [ ] All acceptance criteria marked as complete
- [ ] Code compiles without errors or warnings
- [ ] Migrations tested with run/revert/redo
- [ ] Database connection pool verified
- [ ] Schema matches architecture document
- [ ] Ready for downstream tasks (2, 3, 4, 5)
