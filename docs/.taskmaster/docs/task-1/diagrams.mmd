%% Database Schema Diagram for Task 1
%% E-Commerce Database Structure

graph TD
    subgraph "Database Schema"
        Users["<b>users</b><br/>━━━━━━━━━<br/>PK: id (SERIAL)<br/>username (VARCHAR, UNIQUE)<br/>email (VARCHAR, UNIQUE)<br/>password_hash (VARCHAR)<br/>created_at (TIMESTAMP)"]

        Products["<b>products</b><br/>━━━━━━━━━<br/>PK: id (SERIAL)<br/>name (VARCHAR)<br/>description (TEXT)<br/>price (NUMERIC)<br/>inventory_count (INTEGER)"]

        Carts["<b>carts</b><br/>━━━━━━━━━<br/>PK: id (SERIAL)<br/>FK: user_id → users(id)<br/>created_at (TIMESTAMP)"]

        CartItems["<b>cart_items</b><br/>━━━━━━━━━<br/>PK: id (SERIAL)<br/>FK: cart_id → carts(id)<br/>FK: product_id → products(id)<br/>quantity (INTEGER)"]
    end

    Users -->|"1 to N"| Carts
    Carts -->|"1 to N"| CartItems
    Products -->|"1 to N"| CartItems

    style Users fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style Products fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style Carts fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style CartItems fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px

%% Module Structure Diagram

graph LR
    subgraph "Module Structure"
        Main["src/main.rs<br/>or<br/>src/lib.rs"]
        Config["src/config/<br/>━━━━━━━━━<br/>mod.rs<br/>db.rs"]
        Models["src/models.rs<br/>━━━━━━━━━<br/>User, NewUser<br/>Product, NewProduct<br/>Cart, NewCart<br/>CartItem, NewCartItem"]
        Schema["src/schema.rs<br/>━━━━━━━━━<br/>table! macros<br/>joinable! macros<br/>allow_tables_to_appear_in_same_query!"]
    end

    Main -->|"pub mod"| Config
    Main -->|"pub mod"| Models
    Main -->|"pub mod"| Schema

    style Main fill:#ffebee,stroke:#c62828,stroke-width:2px
    style Config fill:#e0f2f1,stroke:#004d40,stroke-width:2px
    style Models fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    style Schema fill:#e8eaf6,stroke:#1a237e,stroke-width:2px

%% Migration Flow Diagram

sequenceDiagram
    participant Dev as Developer
    participant CLI as Diesel CLI
    participant DB as PostgreSQL
    participant Files as Migration Files

    Dev->>CLI: diesel setup
    CLI->>Files: Create migrations/ directory
    CLI->>DB: Initialize diesel setup

    Dev->>CLI: diesel migration generate create_users
    CLI->>Files: Create up.sql & down.sql

    Dev->>Files: Write CREATE TABLE users
    Dev->>Files: Write DROP TABLE users

    Dev->>CLI: diesel migration generate create_products
    CLI->>Files: Create up.sql & down.sql

    Dev->>CLI: diesel migration generate create_carts
    CLI->>Files: Create up.sql & down.sql

    Dev->>CLI: diesel migration generate create_cart_items
    CLI->>Files: Create up.sql & down.sql

    Dev->>CLI: diesel migration run
    CLI->>DB: Apply users migration
    CLI->>DB: Apply products migration
    CLI->>DB: Apply carts migration
    CLI->>DB: Apply cart_items migration
    CLI->>Files: Generate/update schema.rs

    Dev->>CLI: diesel migration redo
    CLI->>DB: Rollback last migration
    CLI->>DB: Reapply last migration

%% Connection Pool Architecture

graph TB
    subgraph "Connection Pool Architecture"
        App["Application<br/>━━━━━━━━━<br/>Actix-web Server"]
        Pool["Connection Pool<br/>━━━━━━━━━<br/>r2d2::Pool<br/>Max Connections: 10"]

        subgraph "Pool Connections"
            Conn1["PgConnection 1"]
            Conn2["PgConnection 2"]
            Conn3["PgConnection 3"]
            ConnN["PgConnection N"]
        end

        DB["PostgreSQL<br/>━━━━━━━━━<br/>Database Server"]
        Env[".env<br/>━━━━━━━━━<br/>DATABASE_URL"]
    end

    Env -->|"dotenv::dotenv()"| App
    App -->|"establish_connection_pool()"| Pool
    Pool --> Conn1
    Pool --> Conn2
    Pool --> Conn3
    Pool --> ConnN
    Conn1 --> DB
    Conn2 --> DB
    Conn3 --> DB
    ConnN --> DB

    style App fill:#e3f2fd,stroke:#0d47a1,stroke-width:2px
    style Pool fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    style DB fill:#fce4ec,stroke:#880e4f,stroke-width:3px
    style Env fill:#fff9c4,stroke:#f57f17,stroke-width:2px
