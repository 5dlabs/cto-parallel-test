<?xml version="1.0" encoding="UTF-8"?>
<prompt>
    <role>You are a senior Rust backend developer specializing in API development, authentication, and multi-module integration.</role>

    <task>
        <id>5</id>
        <title>Shopping Cart API</title>
        <description>Create shopping cart functionality and API endpoints with JWT authentication and product validation. Integrate Task 3 (Authentication) for JWT validation and Task 4 (Product Catalog) for product lookup and inventory checking. Implement cart service with user-specific cart management and REST API endpoints for cart operations.</description>
        <priority>high</priority>
        <status>pending</status>
        <dependencies>3,4</dependencies>
        <level>1</level>
        <estimated_time>45 minutes</estimated_time>
    </task>

    <technical_specifications>
        <spec>Integrate JWT authentication from Task 3 for all cart endpoints</spec>
        <spec>Integrate ProductService from Task 4 for product validation</spec>
        <spec>Implement thread-safe CartService using Arc and Mutex with HashMap storage</spec>
        <spec>Create Cart and CartItem models with product data denormalization</spec>
        <spec>Implement REST API with GET, POST, DELETE operations</spec>
        <spec>Validate products exist and have sufficient inventory before adding</spec>
        <spec>Return appropriate HTTP status codes (200, 400, 401, 404)</spec>
        <spec>Support user-specific carts identified by JWT user_id</spec>
    </technical_specifications>

    <implementation_details>
        <overview>This task integrates authentication and catalog modules to create a complete shopping cart system. It is a Level 1 task that depends on Tasks 3 and 4 completing first.</overview>

        <step number="1">
            <action>Create src/cart/mod.rs with module exports</action>
            <details>Export service module and CartService type</details>
        </step>

        <step number="2">
            <action>Create src/cart/service.rs with cart management</action>
            <details>
                Define CartItem and Cart structs.
                Implement CartService with HashMap storage.
                Methods: new, get_or_create_cart, add_item, remove_item, get_cart, clear_cart.
                Use Arc&lt;Mutex&lt;&gt;&gt; for thread safety.
                Store denormalized product data in CartItem.
            </details>
        </step>

        <step number="3">
            <action>Create src/api/cart_routes.rs with authenticated endpoints</action>
            <details>
                Implement configure_cart_routes with /cart scope.
                Create handlers: get_cart, add_item, remove_item, clear_cart.
                Extract JWT from Authorization header in all handlers.
                Validate token with Task 3's validate_token.
                Return 401 if authentication fails.
                Validate products with Task 4's ProductService.
                Check inventory before adding items.
            </details>
        </step>

        <step number="4">
            <action>Update src/api/mod.rs to include cart_routes</action>
            <details>Add: pub mod cart_routes;</details>
        </step>

        <step number="5">
            <action>Update src/api/routes.rs to configure cart routes</action>
            <details>
                Import configure_cart_routes.
                Add .configure(configure_cart_routes) to configure_routes function.
            </details>
        </step>

        <step number="6">
            <action>Update src/main.rs to register CartService</action>
            <details>
                Declare cart module.
                Create CartService instance.
                Add to app with .app_data(cart_service.clone()).
            </details>
        </step>
    </implementation_details>

    <acceptance_criteria>
        <criterion>Files src/cart/mod.rs, src/cart/service.rs, and src/api/cart_routes.rs created</criterion>
        <criterion>Files src/api/mod.rs, src/api/routes.rs, and src/main.rs updated correctly</criterion>
        <criterion>CartService manages user-specific carts with HashMap storage</criterion>
        <criterion>All cart endpoints require valid JWT from Authorization header</criterion>
        <criterion>JWT validation uses Task 3's validate_token function</criterion>
        <criterion>Product validation uses Task 4's ProductService.get_by_id</criterion>
        <criterion>add_item checks inventory before adding to cart</criterion>
        <criterion>CartItem stores product_name and unit_price (denormalized)</criterion>
        <criterion>Adding existing product increments quantity instead of duplicating</criterion>
        <criterion>All endpoints return appropriate status codes (200, 400, 401, 404)</criterion>
        <criterion>cargo check and cargo build complete without errors</criterion>
        <criterion>All module integrations work correctly</criterion>
    </acceptance_criteria>

    <test_strategy>
        <validation>Test cart service, authentication, and product validation independently and together.</validation>
        <integration_testing>Verify integration with Tasks 2, 3, and 4.</integration_testing>
    </test_strategy>

    <instructions>
        Follow implementation steps exactly. Integrate auth and catalog modules. Test thoroughly.
    </instructions>

    <context>
        <project>
            <name>Parallel Task Execution Test</name>
            <repository>https://github.com/5dlabs/cto-parallel-test</repository>
        </project>
        <execution_context>
            <level>1</level>
            <depends_on>Tasks 3, 4</depends_on>
            <enables>Task 7</enables>
        </execution_context>
    </context>
</prompt>
